# ISICGUI — Генератор синтетических дерматоскопических изображений (ISIC)

Инструмент для оффлайн-генерации синтетических изображений кожных поражений с GUI на PyQt5, поддержкой диффузионных моделей, постобработки цветовых характеристик и интеграции XAI (объяснимого ИИ) для интерпретации результатов.

##  ВАЖНО: Загрузка моделей

**Модели для работы программы не включены в репозиторий**.

###  Автоматическая загрузка (рекомендуется)

1. **Windows**: Запустите `download_models.bat` двойным кликом
2. **Linux/Mac**: Выполните `python download_models.py`

Скрипт автоматически:
-  Создаст папку `checkpoints/`
-  Загрузит все модели с Google Drive
-  Распакует архивы
-  Покажет прогресс загрузки

## Быстрый старт: как пользоваться

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

2. Подготовьте структуру проекта:
   - Папка с моделями: `checkpoints/`
     - Обязательный формат имен для UNet-чекпоинтов: `unet_<КЛАСС>_best.pth`, например: `unet_MEL_best.pth`, `unet_NV_best.pth`.
     - Необязательный файл цветовой статистики: `color_statistics.json` (см. раздел «Цветовая постобработка»).
     - Необязательный классификатор для XAI: `classifier.pth` (адаптивная ResNet-архитектура).
   - Папка для результатов (по умолчанию создается автоматически): `generated_images/`
   - Папка для XAI-результатов: `xai_results/` (создается автоматически при первом запуске XAI).

3. Запустите интерфейс:
   ```bash
   python main.py
   ```

4. В верхней панели:
   - Нажмите «Выбрать модель» и укажите каталог `checkpoints/` с файлами `unet_<КЛАСС>_best.pth`.
   - Нажмите «Выбрать папку вывода» и укажите каталог для сохранения результатов (например, `generated_images/`).
   - При необходимости включите «XAI Mode» (выполняет параллельный анализ и оверлеи внимания). Частота сохранения шагов XAI настраивается через «XAI шаги» и переменную окружения `XAI_SAVE_EVERY_N`.
   - Выберите устройство «CPU» или «CUDA:<id>». При смене устройства модели будут перегружены при следующей генерации.

5. В левой панели («Выбор и настройка классов»):
   - Отметьте чекбоксами классы, для которых имеются чекпоинты в `checkpoints/`.
   - Для каждого выбранного класса задайте количество изображений.
   - Нажмите «Начать генерацию».

6. Мониторинг и результаты:
   - Прогресс-бар отображает ход генерации, логи выводятся в нижней панели.
   - Изображения сохраняются в выбранной папке, автоматически раскладываются по подпапкам классов и индексируются в `synthetic_dataset.csv`.
   - В правой панели доступны списки классов/файлов; клик по файлу открывает превью в центральной области. Клик по изображению — открытие в системной программе.
   - При активном XAI результаты сохраняются в `xai_results/<timestamped_run>/` и могут быть просмотрены в правой панели («Результаты XAI»).

7. Управление процессом:
   - «Остановить генерацию» корректно прекращает текущий цикл.
   - «Регенерировать» повторяет последнюю конфигурацию классов/чисел.

## Требования

- Python 3.8+
- PyQt5
- PyTorch (CPU или CUDA)
- Diffusers
- Pillow, NumPy, tqdm
- (Опционально) Captum, torchvision, matplotlib — для XAI и визуализации теплокарт

Установка базовых зависимостей:
```bash
pip install -r requirements.txt
```
Дополнительно для XAI:
```bash
pip install captum torchvision matplotlib
```

## Архитектура и компоненты

- GUI (`main.py`):
  - Класс `SyntheticDataGenerator` организует интерфейс, состояния, асинхронных воркеров и XAI-пайплайн.
  - Поддерживает горячее переключение устройства, превью изображений, интеграцию XAI-оверлеев в просмотрщик.

- Конфигурация (`core/config/config_manager.py`):
  - `ConfigManager` управляет путями (`checkpoints`, `output`, `cache`, `logs`), параметрами генерации и UI; сохраняет конфиг в системно-зависимом месте.

- Генерация (`core/generator/image_generator.py`):
  - `ImageGenerator` оркестрирует загрузку моделей, шаги диффузии и постобработку.
  - Использует `ModelManager` для UNet и `DDPMScheduler` (1000 train timesteps, inference по умолчанию 50 шагов; синхронизируется с XAI).
  - Ведет `synthetic_dataset.csv` c колонками: `filename, class, isic_number, source, generated_at`.
  - Выполняет агрессивную очистку памяти CUDA между изображениями для стабильности длительных прогонов.

- Менеджер моделей (`core/generator/model_manager.py`):
  - Ищет чекпоинты по шаблону `unet_<CLASS>_best.pth` в `checkpoints/`.
  - Создает совместимую архитектуру `UNet2DModel` с блоками внимания, загружает веса, настраивает `DDPMScheduler`.

- Логи/Пути/Кэш (`core/utils`, `core/cache`):
  - Логи: `core/logs/generator.log` и другие; при запуске GUI очищаются заголовком.
  - `PathManager` обеспечивает генерирование имён в стиле ISIC и авто-инкремент индекса.
  - `CacheManager` кэширует архитектуры/веса между вызовами.

- XAI (`xai/xai_integration.py`):
  - Функция `run_xai_analysis(image_path, device, classifier_path, save_dir)` возвращает `(overlay_pil, saved_path)`.
  - Классификатор: адаптивная `ResNet18` под 8 классов (может частично инициализироваться из `classifier.pth`).
  - Метод атрибуции по умолчанию — Integrated Gradients (Captum). Есть деградация к градиентам при отсутствии Captum.
  - Формирует теплокарту и сохраняет оверлей в `xai_results/`.

## Нюансы и воспроизводимость

- Именование чекпоинтов: строго `unet_<CLASS>_best.pth`. Классы, не имеющие соответствующих файлов, в GUI будут недоступны.
- Размер входа: 128×128, 3 канала (RGB). Шаги диффузии при инференсе по умолчанию — 50 (настраиваются из кода/окружения).
- Seed: в GUI устанавливается базовый seed (например, 42) для воспроизводимости; генератор синхронизирует генерацию шума и XAI.
- Очистка памяти: после каждого изображения проводится `torch.cuda.empty_cache()` и синхронизация для предотвращения OOM при больших сериях.
- CSV: файл `synthetic_dataset.csv` создаётся/перезаписывается при каждом запуске генерации в корне выбранной выходной папки.
- Цветовая постобработка: если в `checkpoints/color_statistics.json` присутствуют статистики вида `{ "<CLASS>": { "rgb": { "mean": [r,g,b], "std": [r,g,b] } } }`, то применяется мягкая нормализация цвета (ограниченный масштаб, смешивание с оригиналом ~0.35).

## Диагностика и типичные проблемы

- «Не найдена модель для класса …»: проверьте имя файла чекпоинта и расположение в `checkpoints/`.
- «CUDA недоступна»: убедитесь, что PyTorch собран с той же версией CUDA, что установлена в системе; при необходимости используйте CPU-режим.
- «XAI: скрипт не найден»: для полного пайплайна нужен `xai/XAI.py`. Для лёгкого оверлея достаточно `xai/xai_integration.py` и (опционально) `checkpoints/classifier.pth`.
- Пустые превью: убедитесь, что выбран корректный каталог вывода и изображения действительно сгенерированы.
- Отсутствуют теплокарты: установите `captum` и `matplotlib`; при их отсутствии будет использован простой градиент, а визуализация может быть недоступна.

## Научное позиционирование

- Методология: диффузионная генерация с UNet2D и DDPM-планировщиком, обученным на дерматоскопических изображениях ISIC; постобработка согласовывает цвет с эмпирическими статистиками классов.
- Интерпретируемость: XAI-оверлеи на основе атрибуционных методов (Integrated Gradients) для верификации фокусировки модели и выявления артефактов.
- Воспроизводимость: фиксированные гиперпараметры инференса, контролируемый seed, логирование окружения/устройств, CSV метаданных для последующего аудита.

## Лицензия и авторы

- Авторы: Лопатин Максим Алексеевич, Трусов Иван Александрович
- Лицензия: исследовательское и учебное использование. Убедитесь, что соблюдаете лицензию и правила использования датасета ISIC при публикациях и распространении синтетических данных.

